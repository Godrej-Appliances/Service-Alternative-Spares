<!DOCTYPE html>
<html>
<head>
    <title>BAAN code & Alternative check</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <style>
        body {
            font-family: G&B Body Copy;
            background: #f4f6f9;
            margin: 0;
            padding: 0;
        }

        .header {
            background: #810055;
            color: white;
            padding: 20px;
            font-size: 20px;
        }

        .container {
            padding: 30px;
        }

        input {
            padding: 10px;
            width: 300px;
            font-size: 14px;
        }

        .card {
            background: white;
            padding: 20px;
            margin-top: 20px;
            border-radius: 6px;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .low-stock {
            color: red;
            font-weight: bold;
        }

        .stock-line {
            margin: 5px 0;
        }

        .no-data {
            color: red;
        }

        @media(max-width:600px){
            input { width: 100%; }
        }
    </style>
</head>

<body>

<div class="header">
    BAAN code & Alternative check
</div>

<div class="container">

    <input type="text" id="itemCode" 
           placeholder="Enter Old or New Item Code"
           onkeyup="searchItem()">

    <div id="output"></div>

</div>

<script>

let mappingData = [];
let spareData = [];
let stockData = [];

function clean(value) {
    return value ? value.toString().trim().toUpperCase() : "";
}

// Load Mapping CSV
Papa.parse("Ban Item_Code_Mapping (7).csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        mappingData = results.data;
    }
});

// Load Spare CSV
Papa.parse("sparedata.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        spareData = results.data;
    }
});

// Load Stock CSV
Papa.parse("Spares stock.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        stockData = results.data;
    }
});


// ================= STOCK FUNCTION =================

function getStockHTML(itemCode) {

    let stockVW = stockData.filter(row =>
        clean(row["Item code"]) === clean(itemCode) &&
        (clean(row["Warehouse code"]) === "ZBF12T" ||
         clean(row["Warehouse code"]) === "ZBF12S")
    );

    let html = "";
    let total = 0;

    if (stockVW.length > 0) {

        stockVW.forEach(row => {

            let qty = parseFloat(row["Stock on Hand"]) || 0;
            total += qty;

            let cls = qty < 5 ? "low-stock" : "";

            html += `
                <div class="stock-line ${cls}">
                    ${row["Warehouse code"]} : ${qty}
                </div>
            `;
        });

        html += `<hr><strong>Total Stock: ${total}</strong>`;

    } else {
        html = `<div class="no-data">No Stock Available</div>`;
    }

    return html;
}


// ================= MAIN SEARCH FUNCTION =================

function searchItem() {

    let code = clean(document.getElementById("itemCode").value);
    let output = document.getElementById("output");

    if (code.length < 2) {
        output.innerHTML = "";
        return;
    }

    let newCode = null;
    let description = null;
    let altCode = null;
    let altDescription = null;

    // ===== STEP 1: Mapping Check =====
    let mapping = mappingData.find(row =>
        clean(row.Old_Item_Code) === code ||
        clean(row.New_item_code) === code
    );

    if (mapping) {
        newCode = clean(mapping.New_item_code);
        description = mapping.New_Item_Desc;
    } else {
        newCode = code;
    }

    // ===== STEP 2: Spare Lookup =====
    let spare = spareData.find(row =>
        clean(row["Item"]) === newCode
    );

    if (spare) {

        if (!description && spare["Desc."]) {
            description = spare["Desc."];
        }

        if (spare["AlternativeItem"]) {
            altCode = clean(spare["AlternativeItem"]);
        }

        if (altCode) {

            if (spare["AlternativeDesc."]) {
                altDescription = spare["AlternativeDesc."];
            }

            if (!altDescription) {
                let altRow = spareData.find(row =>
                    clean(row["Item"]) === altCode
                );

                if (altRow && altRow["Desc."]) {
                    altDescription = altRow["Desc."];
                }
            }

            if (!altDescription) {
                altDescription = "Not Available";
            }
        }
    }

    // ===== STEP 3: STOCK DESCRIPTION FALLBACK =====
    if (!description) {

        let stockRow = stockData.find(row =>
            clean(row["Item code"]) === newCode
        );

        if (stockRow && stockRow["Item Description"]) {
            description = stockRow["Item Description"];
        }
    }

    if (!description) {
        description = "Not Available";
    }

    // ===== STEP 4: Check Existence Anywhere =====
    let existsAnywhere =
        mapping ||
        spare ||
        stockData.some(row => clean(row["Item code"]) === newCode);

    if (!existsAnywhere) {
        output.innerHTML = `
            <div class="card">
                <div class="no-data">Please Enter Correct Item Code</div>
            </div>
        `;
        return;
    }

    // ===== RENDER OUTPUT =====
    output.innerHTML = `

        <div class="card">
            <div class="section-title">Main Item</div>
            <div><strong>Item Code:</strong> ${newCode}</div>
            <div><strong>Description:</strong> ${description}</div>

            <div style="margin-top:15px;">
                <strong>Warehouse Stock</strong>
                ${getStockHTML(newCode)}
            </div>
        </div>

        <div class="card">
            <div class="section-title">Alternative Item</div>
            ${
                altCode ?
                `
                    <div><strong>Alternative Code:</strong> ${altCode}</div>
                    <div><strong>Description:</strong> ${altDescription}</div>

                    <div style="margin-top:15px;">
                        <strong>Warehouse Stock</strong>
                        ${getStockHTML(altCode)}
                    </div>
                `
                :
                `<div class="no-data">No Alternative Available</div>`
            }
        </div>
    `;
}

</script>

</body>
</html>
