<!DOCTYPE html>
<html>
<head>
    <title>BAAN Code & Alternative Spare Check</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <style>
        body {
            font-family: Arial;
            background: #f4f6f9;
            margin: 0;
            padding: 0;
        }

        .header {
            background: #1f2d3d;
            color: white;
            padding: 20px;
            font-size: 20px;
        }

        .container {
            padding: 30px;
        }

        input {
            padding: 10px;
            width: 300px;
            font-size: 14px;
        }

        .card {
            background: white;
            padding: 20px;
            margin-top: 20px;
            border-radius: 6px;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .low-stock {
            color: red;
            font-weight: bold;
        }

        .stock-line {
            margin: 5px 0;
        }

        .no-data {
            color: gray;
        }

        @media(max-width:600px){
            input { width: 100%; }
        }
    </style>
</head>

<body>

<div class="header">
    BAAN Code & Alternative Spare Check
</div>

<div class="container">

    <input type="text" id="itemCode" 
           placeholder="Enter Old or New Item Code"
           onkeyup="searchItem()">

    <div id="output"></div>

</div>

<script>

let mappingData = [];
let spareData = [];
let stockData = [];

// Load CSV Files
Papa.parse("Ban Item_Code_Mapping (7).csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        mappingData = results.data;
    }
});

Papa.parse("sparedata.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        spareData = results.data;
    }
});

Papa.parse("Spares stock.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        stockData = results.data;
    }
});


// ================= STOCK FUNCTION =================

function getStockHTML(itemCode) {

    if (!itemCode) return `<div class="no-data">No Stock Available</div>`;

    let stockVW = stockData.filter(row =>
        row["Item code"] &&
        row["Item code"].trim() === itemCode.trim() &&
        (row["Warehouse code"] === "ZBF12T" ||
         row["Warehouse code"] === "ZBF12S")
    );

    let html = "";
    let total = 0;

    if (stockVW.length > 0) {

        stockVW.forEach(row => {

            let qty = parseFloat(row["Stock on Hand"]) || 0;
            total += qty;

            let cls = qty < 5 ? "low-stock" : "";

            html += `
                <div class="stock-line ${cls}">
                    ${row["Warehouse code"]} : ${qty}
                </div>
            `;
        });

        html += `<hr><strong>Total Stock: ${total}</strong>`;

    } else {
        html = `<div class="no-data">No Stock Available</div>`;
    }

    return html;
}


// ================= MAIN SEARCH FUNCTION =================

function searchItem() {

    let code = document.getElementById("itemCode").value.trim();
    let output = document.getElementById("output");

    if (code.length < 2) {
        output.innerHTML = "";
        return;
    }

    let newCode = null;
    let description = null;

    // ===== Step 1: Check Mapping =====
    let mapping = mappingData.find(row =>
        (row.Old_Item_Code && row.Old_Item_Code.trim() === code) ||
        (row.New_item_code && row.New_item_code.trim() === code)
    );

    if (mapping) {
        newCode = mapping.New_item_code.trim();
        description = mapping.New_Item_Desc;
    } else {
        newCode = code;
    }

    // ===== Step 2: Check Spare Data =====
    let spare = spareData.find(row =>
        row.Item && row.Item.trim() === newCode.trim()
    );

    let altCode = null;
    let altDescription = null;

    if (spare) {

        // Main Description fallback
        if (!description && spare["Desc."]) {
            description = spare["Desc."];
        }

        // Alternative Code
        if (spare.AlternativeItem && spare.AlternativeItem.trim() !== "") {
            altCode = spare.AlternativeItem.trim();
        }

        // Alternative Description Logic
        if (altCode) {

            // 1️⃣ Try same row alt description
            if (spare["Desc..1"] && spare["Desc..1"].trim() !== "") {
                altDescription = spare["Desc..1"];
            } 
            else {
                // 2️⃣ Search alternative item separately
                let altRow = spareData.find(row =>
                    row.Item && row.Item.trim() === altCode
                );

                if (altRow && altRow["Desc."] && altRow["Desc."].trim() !== "") {
                    altDescription = altRow["Desc."];
                } else {
                    altDescription = "Not Available";
                }
            }
        }
    }

    // ===== Step 3: Check Existence =====
    let hasStock = stockData.some(row =>
        row["Item code"] &&
        row["Item code"].trim() === newCode.trim()
    );

    let hasSpare = spare !== undefined;
    let hasMapping = mapping !== undefined;

    if (!hasStock && !hasSpare && !hasMapping) {
        output.innerHTML = `
            <div class="card">
                <div class="no-data">Item Not Found Anywhere</div>
            </div>
        `;
        return;
    }

    // ===== Render Output =====

    output.innerHTML = `

        <div class="card">
            <div class="section-title">Main Item</div>
            <div><strong>Item Code:</strong> ${newCode}</div>
            <div><strong>Description:</strong> ${description || "Not Available"}</div>

            <div style="margin-top:15px;">
                <strong>Warehouse Stock</strong>
                ${getStockHTML(newCode)}
            </div>
        </div>

        <div class="card">
            <div class="section-title">Alternative Item</div>
            ${
                altCode ?
                `
                    <div><strong>Alternative Code:</strong> ${altCode}</div>
                    <div><strong>Description:</strong> ${altDescription}</div>

                    <div style="margin-top:15px;">
                        <strong>Warehouse Stock</strong>
                        ${getStockHTML(altCode)}
                    </div>
                `
                :
                `<div class="no-data">No Alternative Available</div>`
            }
        </div>
    `;
}

</script>

</body>
</html>
